name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, converted_to_draft]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'AGENTS.md'
      - 'QWEN.md'
  push:
    branches:
      - main
    paths:
      - '**.py'
      - '.github/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  pr_gate:
    name: PR Gate
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-')))
    runs-on: ubuntu-latest
    steps:
      - name: PR Gate no-op
        run: echo "PR Gate (event=${{ github.event_name }}, action=${{ github.event.action }})"
      - name: Convert PR to draft
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened') && github.event.pull_request.draft == false && github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.PR_DRAFT_TOKEN }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
        run: |
          set -euo pipefail
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "Missing PR_DRAFT_TOKEN secret." >&2
            exit 1
          fi
          payload="$(python - <<'PY'
          import json, os
          pr_id = os.environ["PR_NODE_ID"]
          print(json.dumps({
            "query": "mutation($id:ID!){ convertPullRequestToDraft(input:{pullRequestId:$id}){ pullRequest{ isDraft } } }",
            "variables": {"id": pr_id},
          }))
          PY
          )"

          resp="$(curl -fsS \
            -H "Authorization: bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/graphql \
            --data "${payload}")"

          RESP="${resp}" python - <<'PY'
          import json, os, sys
          resp = json.loads(os.environ["RESP"])
          if resp.get("errors"):
            print(json.dumps(resp["errors"], indent=2), file=sys.stderr)
            raise SystemExit(1)
          is_draft = (
            resp.get("data", {})
            .get("convertPullRequestToDraft", {})
            .get("pullRequest", {})
            .get("isDraft")
          )
          if is_draft is not True:
            print(resp, file=sys.stderr)
            raise SystemExit(1)
          print("converted_to_draft=true")
          PY

  changes:
    needs: pr_gate
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-')))
    runs-on: ubuntu-latest
    outputs:
      run_ci: ${{ steps.filter.outputs.run_ci }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" != 'pull_request' ]; then
            echo "run_ci=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          HEAD_SHA='${{ github.event.pull_request.head.sha }}'

          git fetch --no-tags --prune --depth=2 origin "$BASE_SHA"

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")

          run_ci=false
          for file in $CHANGED_FILES; do
            case "$file" in
              *.py|**/*.py|.github/*|.github/**|pyproject.toml|requirements.txt|requirements-ci.txt|scripts/*|scripts/**)
                run_ci=true
                break
                ;;
              app/agent/currency_options.py|app/webui/src/constants/currencyOptions.ts)
                run_ci=true
                break
                ;;
            esac
          done

          echo "run_ci=$run_ci" >> "$GITHUB_OUTPUT"
  lint:
    needs: changes
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.changes.outputs.run_ci == 'true' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-')))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-
      - name: Install lint dependencies
        run: pip install pre-commit
      - name: Run pre-commit on pull request changes
        if: github.event_name == 'pull_request'
        run: |
          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          HEAD_SHA='${{ github.sha }}'
          git fetch --no-tags --prune --depth=2 origin "$BASE_SHA"
          pre-commit run --from-ref "$BASE_SHA" --to-ref "$HEAD_SHA"
      - name: Run pre-commit on pushed commits
        if: github.event_name != 'pull_request'
        run: |
          BASE_SHA=$(git rev-parse HEAD^ 2>/dev/null || echo "")
          if [ -z "$BASE_SHA" ]; then
            pre-commit run --all-files
          else
            pre-commit run --from-ref "$BASE_SHA" --to-ref HEAD
          fi

  build:
    needs:
      - changes
      - lint
    # Full build runs only when the PR is not a draft.
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.changes.outputs.run_ci == 'true' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-'))) && (github.event_name != 'pull_request' || github.event.pull_request.draft == false)
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache virtualenv (Linux)
        if: matrix.os == 'ubuntu-latest'
        id: cache-venv-linux
        uses: actions/cache@v4
        with:
          path: .venv
          key: Linux-venv-3.11-${{ hashFiles('requirements-ci.txt') }}
          restore-keys: |
            Linux-venv-3.11-
      - name: Cache virtualenv (Windows)
        if: matrix.os == 'windows-latest'
        id: cache-venv-windows
        uses: actions/cache@v4
        with:
          path: .venv
          key: Windows-venv-3.11-${{ hashFiles('requirements-ci.txt') }}
          restore-keys: |
            Windows-venv-3.11-
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          if [ "${{ steps.cache-venv-linux.outputs.cache-hit }}" != 'true' ]; then
            rm -rf .venv
            python -m venv .venv
          fi
          .venv/bin/pip install -r requirements-ci.txt
      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if ('${{ steps.cache-venv-windows.outputs.cache-hit }}' -ne 'true') {
            if (Test-Path ".venv") {
              Remove-Item -Recurse -Force .venv
            }
            python -m venv .venv
          }
          .\.venv\Scripts\pip install -r requirements-ci.txt
      - name: Run tests (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          set +e
          .venv/bin/pytest -q
          status=$?
          if [ "$status" -eq 5 ]; then
            echo "pytest reported no tests; skipping."
            exit 0
          fi
          exit "$status"
      - name: Run tests (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          .\.venv\Scripts\pytest -q
          $status = $LASTEXITCODE
          if ($status -eq 5) {
            Write-Host "pytest reported no tests; skipping."
            exit 0
          }
          exit $status
