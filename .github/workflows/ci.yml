name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, converted_to_draft]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'AGENTS.md'
      - 'QWEN.md'
  push:
    branches:
      - main
    paths:
      - '.github/**'
      - 'app/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: read
  pull-requests: write

jobs:
  pr_gate:
    name: PR Gate
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-')))
    runs-on: ubuntu-latest
    steps:
      - name: PR Gate no-op
        run: echo "PR Gate (event=${{ github.event_name }}, action=${{ github.event.action }})"
      - name: Convert PR to draft
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened') && github.event.pull_request.draft == false && github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.PR_DRAFT_TOKEN }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
        run: |
          set -euo pipefail
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "Missing PR_DRAFT_TOKEN secret." >&2
            exit 1
          fi
          payload="$(node -e '
          const prId = process.env.PR_NODE_ID;
          const payload = {
            query: "mutation($id:ID!){ convertPullRequestToDraft(input:{pullRequestId:$id}){ pullRequest{ isDraft } } }",
            variables: { id: prId }
          };
          process.stdout.write(JSON.stringify(payload));
          ')"

          resp="$(curl -fsS \
            -H "Authorization: bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/graphql \
            --data "${payload}")"

          RESP="${resp}" node -e '
          const resp = JSON.parse(process.env.RESP || "{}");
          if (resp.errors) {
            console.error(JSON.stringify(resp.errors, null, 2));
            process.exit(1);
          }
          const isDraft = resp?.data?.convertPullRequestToDraft?.pullRequest?.isDraft;
          if (isDraft !== true) {
            console.error(JSON.stringify(resp, null, 2));
            process.exit(1);
          }
          console.log("converted_to_draft=true");
          '

  changes:
    needs: pr_gate
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-')))
    runs-on: ubuntu-latest
    outputs:
      run_ci: ${{ steps.filter.outputs.run_ci }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" != 'pull_request' ]; then
            echo "run_ci=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          HEAD_SHA='${{ github.event.pull_request.head.sha }}'

          git fetch --no-tags --prune --depth=2 origin "$BASE_SHA"

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")

          run_ci=false
          for file in $CHANGED_FILES; do
            case "$file" in
              .github/*|.github/**|scripts/*|scripts/**|package.json|package-lock.json)
                run_ci=true
                break
                ;;
              app/tauri/*|app/tauri/**|app/webui/*|app/webui/**|app/tests-ui/*|app/tests-ui/**|app/agent/version.txt)
                run_ci=true
                break
                ;;
            esac
          done

          echo "run_ci=$run_ci" >> "$GITHUB_OUTPUT"
  lint:
    needs: changes
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.changes.outputs.run_ci == 'true' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-')))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            app/webui/package-lock.json
            app/tauri/package-lock.json
            app/tests-ui/package-lock.json

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install web dependencies
        run: npm --prefix app/webui ci

      - name: Web unit tests
        run: npm --prefix app/webui run test

      - name: Web build
        run: npm --prefix app/webui run build

      - name: Rust format (check)
        run: cargo fmt --manifest-path app/tauri/src-tauri/Cargo.toml --check

      - name: Rust clippy
        run: cargo clippy --manifest-path app/tauri/src-tauri/Cargo.toml -- -D warnings

  build:
    needs:
      - changes
      - lint
    # Full build runs only when the PR is not a draft.
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.changes.outputs.run_ci == 'true' && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && !startsWith(github.event.pull_request.head.ref, 'chore/release-prepare-'))) && (github.event_name != 'pull_request' || github.event.pull_request.draft == false)
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            app/webui/package-lock.json
            app/tauri/package-lock.json
            app/tests-ui/package-lock.json

      - uses: dtolnay/rust-toolchain@stable

      - name: Install web dependencies
        run: npm --prefix app/webui ci

      - name: Install tests-ui dependencies
        run: npm --prefix app/tests-ui ci

      - name: UI check (Playwright)
        env:
          UI_CHECK_VIDEO: 0
        run: npm --prefix app/tests-ui run ui-check

      - name: Rust test
        run: cargo test --manifest-path app/tauri/src-tauri/Cargo.toml --locked
