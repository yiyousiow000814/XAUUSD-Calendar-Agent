name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g., v1.2.3)"
        required: true
        type: string
      ref:
        description: "Ref to check/build from on manual runs (e.g., main or a SHA)"
        required: false
        type: string
        default: "main"
      dry_run:
        description: "Validate only (do not move tag / create PR / publish release)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare tag + version
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && (github.event_name != 'push' || github.actor != 'github-actions[bot]')
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.sync.outputs.tag }}
      version: ${{ steps.sync.outputs.version }}
      needs_update: ${{ steps.sync.outputs.needs_update }}
      dry_run: ${{ steps.sync.outputs.dry_run }}
      base_sha: ${{ steps.base.outputs.base_sha }}
      resolved_sha: ${{ steps.finalize.outputs.resolved_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Capture base SHA
        id: base
        run: |
          echo "base_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Check APP_VERSION matches tag
        id: sync
        env:
          REF_NAME: ${{ github.ref_name }}
          INPUT_TAG: ${{ inputs.tag }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const tag = String(process.env.INPUT_TAG || process.env.REF_NAME || "").trim();
          if (!tag) {
            console.error("Missing tag name.");
            process.exit(1);
          }

          const dryRun = String(process.env.DRY_RUN || "false").trim().toLowerCase() === "true";
          const version = tag.startsWith("v") ? tag.slice(1) : tag;
          if (!/^[0-9]+\.[0-9]+\.[0-9]+(?:[-+][0-9A-Za-z.-]+)?$/.test(version)) {
            console.error(`Unsupported tag format: ${tag}`);
            process.exit(1);
          }

          const path = "app/agent/version.txt";
          const current = String(fs.readFileSync(path, "utf8") || "").trim();
          if (!current) {
            console.error(`Empty version file: ${path}`);
            process.exit(1);
          }
          const needsUpdate = current !== version;

          const outPath = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(outPath, `tag=${tag}\n`);
          fs.appendFileSync(outPath, `version=${version}\n`);
          fs.appendFileSync(outPath, `needs_update=${needsUpdate ? "true" : "false"}\n`);
          fs.appendFileSync(outPath, `dry_run=${dryRun ? "true" : "false"}\n`);

          console.log(`tag=${tag}`);
          console.log(`version=${version}`);
          console.log(`current_app_version=${current}`);
          console.log(`needs_update=${needsUpdate}`);
          console.log(`dry_run=${dryRun}`);
          NODE

      - name: Update APP_VERSION, move tag, push main (if needed)
        if: steps.sync.outputs.needs_update == 'true' && steps.sync.outputs.dry_run != 'true'
        env:
          TAG: ${{ steps.sync.outputs.tag }}
          VERSION: ${{ steps.sync.outputs.version }}
          BASE_SHA: ${{ steps.base.outputs.base_sha }}
        run: |
          set -euo pipefail

          git fetch origin main --prune
          main_sha="$(git rev-parse "origin/main")"
          if [ "${main_sha}" != "${BASE_SHA}" ]; then
            echo "Refusing to update main automatically because origin/main != tag commit."
            echo "origin/main=${main_sha}"
            echo "tag_commit=${BASE_SHA}"
            echo "Push the tag from the latest main commit, then re-run."
            exit 1
          fi

          git checkout --detach "${BASE_SHA}"

          node scripts/sync-version.mjs --set "${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          tag_type="$(git cat-file -t "${TAG}" 2>/dev/null || echo "commit")"
          tag_message_file="$(mktemp)"
          if [ "${tag_type}" = "tag" ]; then
            git for-each-ref "refs/tags/${TAG}" --format='%(contents)' > "${tag_message_file}" || true
          fi

          git switch -C main "${BASE_SHA}"
          git add app/agent/version.txt app/tauri/src-tauri/Cargo.toml app/tauri/src-tauri/tauri.conf.json app/tauri/package.json app/webui/package.json
          git commit -m "chore: release ${TAG}"
          git push origin HEAD:main

          if [ "${tag_type}" = "tag" ]; then
            git tag -a -f "${TAG}" -F "${tag_message_file}"
          else
            git tag -f "${TAG}"
          fi
          git push origin "refs/tags/${TAG}" --force

      - name: Finalize resolved SHA
        id: finalize
        run: |
          echo "resolved_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build-windows:
    name: Build Setup.exe (Windows)
    needs: prepare
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.prepare.outputs.dry_run != 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.resolved_sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            app/webui/package-lock.json
            app/tauri/package-lock.json

      - uses: dtolnay/rust-toolchain@stable

      - uses: ilammy/msvc-dev-cmd@v1

      - name: Build installer
        shell: pwsh
        run: |
          .\app\installer\build_installer.ps1 -RepoRoot (Resolve-Path ".")
          if (-not (Test-Path "Setup.exe")) {
            throw "Setup.exe not found after build."
          }

      - name: Upload Setup.exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-windows
          path: Setup.exe

  release:
    name: Publish GitHub Release
    needs:
      - prepare
      - build-windows
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.prepare.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download Setup.exe artifact
        uses: actions/download-artifact@v4
        with:
          name: setup-windows
          path: artifacts

      - name: Create GitHub Release (upload Setup.exe only)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: ${{ needs.prepare.outputs.version }}
          generate_release_notes: true
          files: artifacts/Setup.exe
          fail_on_unmatched_files: true
