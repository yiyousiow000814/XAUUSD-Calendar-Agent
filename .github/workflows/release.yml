name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g., v1.2.3)"
        required: true
        type: string
      ref:
        description: "Ref to check/build from on manual runs (e.g., main or a SHA)"
        required: false
        type: string
        default: "main"
      dry_run:
        description: "Validate only (do not move tag / create PR / publish release)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare tag + version
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && (github.event_name != 'push' || github.actor != 'github-actions[bot]')
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.sync.outputs.tag }}
      version: ${{ steps.sync.outputs.version }}
      needs_update: ${{ steps.sync.outputs.needs_update }}
      dry_run: ${{ steps.sync.outputs.dry_run }}
      base_sha: ${{ steps.base.outputs.base_sha }}
      resolved_sha: ${{ steps.finalize.outputs.resolved_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Capture base SHA
        id: base
        run: |
          echo "base_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Check APP_VERSION matches tag
        id: sync
        env:
          REF_NAME: ${{ github.ref_name }}
          INPUT_TAG: ${{ inputs.tag }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}
        run: |
          python - <<'PY'
          import os
          import re
          import sys

          tag = (os.environ.get("INPUT_TAG") or os.environ.get("REF_NAME") or "").strip()
          if not tag:
            print("Missing tag name.", file=sys.stderr)
            sys.exit(1)

          dry_run = (os.environ.get("DRY_RUN") or "false").strip().lower() == "true"

          version = tag[1:] if tag.startswith("v") else tag
          if not re.fullmatch(r"[0-9]+\.[0-9]+\.[0-9]+(?:[-+][0-9A-Za-z.-]+)?", version):
            print(f"Unsupported tag format: {tag}", file=sys.stderr)
            sys.exit(1)

          path = "app/agent/version.py"
          with open(path, "r", encoding="utf-8") as f:
            text = f.read()

          m = re.search(
            r'^\s*APP_VERSION\s*=\s*["\']([^"\']+)["\']\s*$',
            text,
            flags=re.M,
          )
          if not m:
            print(f"Could not parse APP_VERSION in {path}", file=sys.stderr)
            sys.exit(1)

          current = m.group(1)
          needs_update = current != version

          out_path = os.environ["GITHUB_OUTPUT"]
          with open(out_path, "a", encoding="utf-8") as out:
            out.write(f"tag={tag}\n")
            out.write(f"version={version}\n")
            out.write(f"needs_update={'true' if needs_update else 'false'}\n")
            out.write(f"dry_run={'true' if dry_run else 'false'}\n")

          print(f"tag={tag}")
          print(f"version={version}")
          print(f"current_app_version={current}")
          print(f"needs_update={needs_update}")
          print(f"dry_run={dry_run}")
          PY

      - name: Update APP_VERSION, move tag, push main (if needed)
        if: steps.sync.outputs.needs_update == 'true' && steps.sync.outputs.dry_run != 'true'
        env:
          TAG: ${{ steps.sync.outputs.tag }}
          VERSION: ${{ steps.sync.outputs.version }}
          BASE_SHA: ${{ steps.base.outputs.base_sha }}
        run: |
          set -euo pipefail

          git fetch origin main --prune
          main_sha="$(git rev-parse "origin/main")"
          if [ "${main_sha}" != "${BASE_SHA}" ]; then
            echo "Refusing to update main automatically because origin/main != tag commit."
            echo "origin/main=${main_sha}"
            echo "tag_commit=${BASE_SHA}"
            echo "Push the tag from the latest main commit, then re-run."
            exit 1
          fi

          git checkout --detach "${BASE_SHA}"

          python - <<'PY'
          import os
          import re

          version = os.environ["VERSION"]
          path = "app/agent/version.py"
          text = open(path, "r", encoding="utf-8").read()
          updated = re.sub(
            r'^\s*APP_VERSION\s*=\s*.*$',
            f'APP_VERSION = "{version}"',
            text,
            flags=re.M,
          )
          if not updated.endswith("\n"):
            updated += "\n"
          open(path, "w", encoding="utf-8", newline="\n").write(updated)
          PY

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          tag_type="$(git cat-file -t "${TAG}" 2>/dev/null || echo "commit")"
          tag_message_file="$(mktemp)"
          if [ "${tag_type}" = "tag" ]; then
            git for-each-ref "refs/tags/${TAG}" --format='%(contents)' > "${tag_message_file}" || true
          fi

          git switch -C main "${BASE_SHA}"
          git add app/agent/version.py
          git commit -m "chore: release ${TAG}"
          git push origin HEAD:main

          if [ "${tag_type}" = "tag" ]; then
            git tag -a -f "${TAG}" -F "${tag_message_file}"
          else
            git tag -f "${TAG}"
          fi
          git push origin "refs/tags/${TAG}" --force

      - name: Finalize resolved SHA
        id: finalize
        run: |
          echo "resolved_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build-windows:
    name: Build Setup.exe (Windows)
    needs: prepare
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.prepare.outputs.dry_run != 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.resolved_sha }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python build dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-app.txt

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress

      - name: Build installer
        shell: pwsh
        run: |
          .\app\installer\build_installer.ps1 -RepoRoot (Resolve-Path ".")
          if (-not (Test-Path "Setup.exe")) {
            throw "Setup.exe not found after build."
          }

      - name: Upload Setup.exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-windows
          path: Setup.exe

  release:
    name: Publish GitHub Release
    needs:
      - prepare
      - build-windows
    if: github.repository == 'yiyousiow000814/XAUUSD-Calendar-Agent' && needs.prepare.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download Setup.exe artifact
        uses: actions/download-artifact@v4
        with:
          name: setup-windows
          path: artifacts

      - name: Create GitHub Release (upload Setup.exe only)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: ${{ needs.prepare.outputs.version }}
          generate_release_notes: true
          files: artifacts/Setup.exe
          fail_on_unmatched_files: true
